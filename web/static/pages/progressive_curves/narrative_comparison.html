<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>叙事方式性格曲线 - Agentic Society</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }
        .chart-container {
            position: relative;
            min-height: 300px;
            margin-bottom: 20px;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .distance-badge {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        .distance-good {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .distance-medium {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .distance-poor {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container-fluid">
            <!-- Header -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up me-2"></i>叙事方式性格曲线</h5>
                </div>
                <div class="card-body">
                    <!-- Control Panel -->
                    <div class="control-panel">
                        <!-- Analysis Info -->
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle me-2"></i>专题分析说明</h6>
                                    <p class="mb-0">
                                        本分析使用预设的叙事方式数据源，对比不同叙事风格下的性格曲线与人类基线的差异。
                                        使用欧几里得距离评估性格曲线的相似度，距离越小表示与人类基线越接近。
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Controls -->
                        <div class="row mt-3">
                            <div class="col-md-8">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-primary" @click="runAnalysis" :disabled="loading">
                                        <i class="bi bi-play-circle me-1"></i>运行分析
                                    </button>
                                    <button class="btn btn-outline-success" @click="forceRedrawChart" :disabled="!analysisComplete">
                                        <i class="bi bi-arrow-clockwise me-1"></i>重绘图表
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">分析状态:</label>
                                <div class="d-flex align-items-center">
                                    <span class="badge" :class="analysisStatus.class">
                                        {{ analysisStatus.text }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="loading" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在分析叙事方式性格曲线...</p>
                    </div>

                    <div v-else-if="error" class="alert alert-danger">
                        {{ error }}
                    </div>

                    <!-- Analysis Results -->
                    <div v-if="analysisComplete" class="results-section">
                        <!-- Distance Comparison -->
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-bar-chart-line me-2"></i>欧几里得距离对比</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 text-center" v-for="(result, modelName) in results" :key="modelName">
                                        <h6>{{ modelName }}</h6>
                                        <div class="distance-badge" :class="getDistanceClass(result.distances ? result.distances.euclidean : 0)">
                                            距离: {{ result.distances ? result.distances.euclidean.toFixed(4) : 'N/A' }}
                                        </div>
                                        <p class="text-muted mt-2">样本数: {{ result.sample_count || 'N/A' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multi-Chart Visualization -->
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-graph-up me-2"></i>性格曲线对比</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6" v-for="(trait, traitName) in traitCharts" :key="traitName">
                                        <div class="chart-container">
                                            <canvas :id="traitName + 'Chart'"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Summary -->
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-info-circle me-2"></i>分析说明</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>数据源说明:</h6>
                                        <ul class="list-group">
                                            <li class="list-group-item" v-for="(result, modelName) in results" :key="modelName">
                                                <span class="badge" :style="{ backgroundColor: result.color }" class="me-2">{{ modelName }}</span>
                                                {{ result.label }}
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>统计指标解释:</h6>
                                        <p class="text-muted">
                                            <strong>欧几里得距离:</strong> 衡量性格曲线与人类基线的整体差异。距离越小表示越接近人类性格分布。<br>
                                            <strong>性格维度:</strong> 神经质、外向性、开放性、宜人性、尽责性五个维度。<br>
                                            <strong>叙事方式:</strong> 不同叙事风格可能影响AI生成的性格特征表现。
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else class="text-center text-muted mt-5">
                        <i class="bi bi-graph-up display-4"></i>
                        <p class="mt-3">点击"运行分析"开始叙事方式性格曲线分析</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;

        const app = createApp({
            setup() {
                const loading = ref(false);
                const error = ref(null);
                const analysisComplete = ref(false);
                const results = ref({});
                const traitCharts = ref({});
                const chartObjects = ref({});

                // 预设数据源模板（叙事方式）
                const dataSources = [
                    {
                        name: 'deepseek_chat',
                        path: 'deepseek-chat.db',
                        color: '#1f77b4',
                        label: 'DeepSeek-Chat 正常生成'
                    },
                    {
                        name: 'deepseek_chat_antialign',
                        path: 'deepseek-chat-antialign.db',
                        color: '#d62728',
                        label: 'DeepSeek-Chat 抗对齐'
                    },
                    {
                        name: 'deepseek_chat_narrative',
                        path: 'deepseek-chat-narrative.db',
                        color: '#9467bd',
                        label: 'DeepSeek-Chat 叙事'
                    }
                ];

                // 性格维度名称
                const traitNames = ['神经质', '外向性', '开放性', '宜人性', '尽责性'];

                // 分析状态计算属性
                const analysisStatus = computed(() => {
                    if (loading.value) {
                        return { text: '分析中...', class: 'bg-warning' };
                    } else if (analysisComplete.value) {
                        return { text: '分析完成', class: 'bg-success' };
                    } else {
                        return { text: '准备分析', class: 'bg-info' };
                    }
                });

                const runAnalysis = async () => {
                    try {
                        loading.value = true;
                        error.value = null;
                        analysisComplete.value = false;
                        destroyCharts();

                        // 确保ChartJS库已加载
                        if (typeof Chart === 'undefined') {
                            throw new Error('ChartJS库未正确加载，请刷新页面重试');
                        }

                        // 同时分析所有数据源
                        const analysisPromises = dataSources.map(source =>
                            analyzeDataSource(source)
                        );

                        const analysisResults = await Promise.all(analysisPromises);

                        // 构建结果对象
                        const resultsObj = {};
                        analysisResults.forEach((result, index) => {
                            if (result) {
                                resultsObj[dataSources[index].name] = {
                                    ...result,
                                    color: dataSources[index].color,
                                    label: dataSources[index].label
                                };
                            }
                        });

                        results.value = resultsObj;

                        // 构建性格维度图表数据
                        buildTraitCharts(resultsObj);

                        // 等待一小段时间确保DOM完全渲染
                        await new Promise(resolve => setTimeout(resolve, 100));

                        // 渲染图表
                        renderCharts();
                        analysisComplete.value = true;

                    } catch (err) {
                        error.value = err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const analyzeDataSource = async (source) => {
                    const response = await fetch('/api/analysis/personality-curve', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            db_path: source.path,
                            gender: ''
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `${source.label}分析失败`);
                    }

                    return await response.json();
                };

                const buildTraitCharts = (resultsObj) => {
                    const charts = {};

                    traitNames.forEach(traitName => {
                        charts[traitName] = {
                            ages: [],
                            datasets: []
                        };

                        // 严格按照Studio逻辑：动态计算年龄范围，并进行数据剪裁（20-70岁）
                        let minAge = 20; // 强制最小年龄为20岁
                        let maxAge = 70; // 强制最大年龄为70岁
                        let allAges = [];

                        Object.entries(resultsObj).forEach(([modelName, result]) => {
                            if (result.curves && result.curves[traitName] && result.curves[traitName].ages && result.curves[traitName].ages.length > 0) {
                                // 剪裁年龄数据，只保留20-70岁范围内的数据
                                const ages = result.curves[traitName].ages.filter(age => age >= 20 && age <= 70);
                                if (ages.length > 0) {
                                    minAge = Math.max(minAge, Math.min(...ages));
                                    maxAge = Math.min(maxAge, Math.max(...ages));
                                    allAges = allAges.concat(ages);
                                }
                            }
                        });

                        // 使用计算得到的年龄范围
                        if (allAges.length > 0) {
                            charts[traitName].ages = allAges.filter((age, index, arr) => arr.indexOf(age) === index).sort((a, b) => a - b);
                        } else {
                            // 默认使用20-70岁
                            charts[traitName].ages = [20, 30, 40, 50, 60, 70];
                        }

                        // 人类基线数据集 - 使用第一个有效数据源
                        let firstValidResult = null;
                        Object.entries(resultsObj).forEach(([modelName, result]) => {
                            if (result.curves && result.curves[traitName] && result.curves[traitName].human && !firstValidResult) {
                                firstValidResult = result;
                            }
                        });

                        if (firstValidResult && firstValidResult.curves && firstValidResult.curves[traitName] && firstValidResult.curves[traitName].human && firstValidResult.curves[traitName].ages) {
                            // 剪裁human基线数据，只保留20-70岁范围内的数据点
                            const filteredData = firstValidResult.curves[traitName].human.filter((_, index) => {
                                const age = firstValidResult.curves[traitName].ages[index];
                                return age >= 20 && age <= 70;
                            });

                            charts[traitName].datasets.push({
                                label: '人类基线',
                                data: filteredData,
                                borderColor: '#2ca02c',
                                backgroundColor: '#2ca02c',
                                borderWidth: 1,
                                borderDash: [],
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            });
                        }

                        // 添加各模型数据
                        Object.entries(resultsObj).forEach(([modelName, result]) => {
                            if (result.curves && result.curves[traitName] && result.curves[traitName].model && result.curves[traitName].ages) {
                                // 剪裁模型数据，只保留20-70岁范围内的数据点
                                const filteredData = result.curves[traitName].model.filter((_, index) => {
                                    const age = result.curves[traitName].ages[index];
                                    return age >= 20 && age <= 70;
                                });

                                // 判断是否是主题曲线（叙事方式页面主题是叙事曲线）
                                const isMainTheme = result.label.includes('叙事');
                                charts[traitName].datasets.push({
                                    label: result.label,
                                    data: filteredData,
                                    borderColor: result.color,
                                    backgroundColor: result.color,
                                    borderWidth: isMainTheme ? 3 : 1.5,
                                    borderDash: isMainTheme ? [] : [5, 5],
                                    fill: false,
                                    tension: 0.4,
                                    pointRadius: 0
                                });
                            }
                        });
                    });

                    traitCharts.value = charts;
                };

                const renderCharts = () => {
                    destroyCharts();

                    traitNames.forEach(traitName => {
                        renderSingleChart(traitName + 'Chart', traitCharts.value[traitName], traitName);
                    });
                };

                const renderSingleChart = (canvasId, chartData, traitName) => {
                    const createChartWithRetry = (retryCount = 0) => {
                        const ctx = document.getElementById(canvasId);
                        if (!ctx) {
                            console.log('Canvas element not found, retrying...');
                            if (retryCount < 3) {
                                setTimeout(() => createChartWithRetry(retryCount + 1), 100);
                            }
                            return;
                        }

                        try {
                            // 确保canvas有正确的尺寸
                            const container = ctx.parentElement;
                            if (container && container.offsetWidth > 0 && container.offsetHeight > 0) {
                                ctx.width = container.offsetWidth;
                                ctx.height = container.offsetHeight;
                            }

                            const chart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: chartData.ages,
                                    datasets: chartData.datasets
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: {
                                        duration: 0
                                    },
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: `${traitName} - 性格曲线对比`,
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        },
                                        legend: {
                                            display: true,
                                            position: 'top'
                                        }
                                    },
                                    scales: {
                                        x: {
                                            title: {
                                                display: true,
                                                text: '年龄'
                                            },
                                            type: 'linear',
                                            min: 20,
                                            max: 70,
                                            ticks: {
                                                stepSize: 10,
                                                callback: function(value) {
                                                    return Math.round(value); // 确保显示整数年龄
                                                }
                                            }
                                        },
                                        y: {
                                            title: {
                                                display: true,
                                                text: '性格得分'
                                            },
                                            min: 0,
                                            max: 100
                                        }
                                    }
                                }
                            });

                            chartObjects.value[canvasId] = chart;
                            console.log(`Chart ${canvasId} created successfully`);
                        } catch (err) {
                            console.error('Error creating chart:', err);
                            if (retryCount < 3) {
                                setTimeout(() => createChartWithRetry(retryCount + 1), 200);
                            } else {
                                error.value = '图表创建失败: ' + err.message;
                            }
                        }
                    };

                    // 延迟创建图表，确保DOM完全加载
                    setTimeout(() => {
                        createChartWithRetry();
                    }, 100);
                };

                const destroyCharts = () => {
                    Object.values(chartObjects.value).forEach(chart => {
                        if (chart) {
                            try {
                                chart.destroy();
                            } catch (err) {
                                console.warn('Error destroying chart:', err);
                            }
                        }
                    });
                    chartObjects.value = {};
                };

                const forceRedrawChart = () => {
                    if (analysisComplete.value) {
                        renderCharts();
                    }
                };

                const getDistanceClass = (distance) => {
                    if (!distance || distance === 0) return 'distance-poor';
                    if (distance < 5) return 'distance-good';
                    if (distance < 10) return 'distance-medium';
                    return 'distance-poor';
                };

                onMounted(() => {
                    // 初始化代码
                });

                return {
                    loading,
                    error,
                    analysisComplete,
                    results,
                    traitCharts,
                    analysisStatus,
                    runAnalysis,
                    forceRedrawChart,
                    getDistanceClass
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>